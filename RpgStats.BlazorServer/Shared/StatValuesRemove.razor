@using RpgStats.BlazorServer.Model
@using RpgStats.Dto
@inject IHttpClientFactory HttpClientFactory
@inject IDialogService DialogService

<MudDialog DefaultFocus="@DialogDefaultFocus">
    <DialogContent>
        <MudTextField Label="Level" @bind-Value="Level" Numeric="true" onFocus="this.select()" Immediate="true"
                      OnKeyDown="@HandleKeyDown" TextChanged="@CheckIfFieldsAreFilled"/>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Cancel">Abbrechen</MudButton>
        <MudButton OnClick="@Submit" Color="Color.Error" Disabled="@_isSubmitDisabled">Entfernen</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance? MudDialog { get; set; }

    [Parameter] public CharacterDetailDto? Character { get; set; }

    private DefaultFocus DialogDefaultFocus => DefaultFocus.FirstChild;
    private HttpClient HttpClient => HttpClientFactory.CreateClient("RpgStatsApi");
    private int Level { get; set; }
    private bool _isSubmitDisabled = true;


    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private void Submit()
    {
        var response = HttpClient.DeleteAsync($"api/StatValue/DeleteAllStatValuesByCharacterAndLevel/{Character?.Id}/{Level}");
        var content = response.Result.Content.ReadFromJsonAsync<WebApiResponse<List<StatValueDto>>>().Result;
        if (!response.Result.IsSuccessStatusCode || content?.Success == false)
        {
            DialogService.ShowMessageBox("Fehler", "Fehler beim LÃ¶schen der Werte");
            return;
        }

        MudDialog?.Close(DialogResult.Ok(content));
    }

    private void CheckIfFieldsAreFilled()
    {
        _isSubmitDisabled = Level <= 0;
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !_isSubmitDisabled)
        {
            Submit();
        }
    }

}